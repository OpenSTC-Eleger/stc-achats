<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>
        <record id="wkf_openstc_achat_stock_open_engage" model="workflow">
            <field name="name">Marché Bons Commandes</field>
            <field name="osv">open.engagement</field>
            <field name="on_create" eval="True"/>
        </record>

         <!-- 
                            Activités Engagement
        -->
        
        <record id="wkf_open_engage_draft" model="workflow.activity">
            <field name="name">Brouillon</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'draft'})</field>
            <field name="flow_start" eval="True"/>
        </record>

        <record id="wkf_open_engage_to_validate" model="workflow.activity">
            <field name="name">A Valider</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">link_engage_po(),to_validated_engage()</field>
            <field name="split_mode">OR</field>
        </record>
        
        <record id="wkf_open_engage_validate_po_and_invoice" model="workflow.activity">
            <field name="name">Validation Bon Commande et Facture</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="split_mode">AND</field>
            <field name="action">validated_engage()</field>
        </record>
        
        <record id="wkf_open_engage_waiting_reception" model="workflow.activity">
            <field name="name">Attente Réception Produits</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'waiting_reception'})</field>
        </record>
        
        <record id="wkf_open_engage_waiting_invoice" model="workflow.activity">
            <field name="name">Attente Facture Fournisseur</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
        </record>
        
        <record id="wkf_open_engage_waiting_invoice_validated" model="workflow.activity">
            <field name="name">Attente Facture Fournisseur Validée</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'waiting_invoice_validated'})</field>
            <field name="join_mode">AND</field>
        </record>
        
        <record id="wkf_open_engage_except_invoice" model="workflow.activity">
            <field name="name">Exception sur Validation Facture</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'except_invoice'})</field>
        </record>
        
        <record id="wkf_open_engage_engage_to_terminate" model="workflow.activity">
            <field name="name">Engagement A Terminer</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="join_mode">XOR</field>
            <field name="kind">function</field>
            <field name="action">write({'state':'engage_to_terminate','reception_ok':True})</field>
        </record>
        
        <record id="wkf_open_engage_done" model="workflow.activity">
            <field name="name">Clos</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">engage_done()</field>
            <field name="flow_stop" eval="True"/>
        </record>
        
        <record id="wkf_open_engage_except_check" model="workflow.activity">
            <field name="name">Engagement Refusé par DST ou Elu</field>
            <field name="wkf_id" ref="wkf_openstc_achat_stock_open_engage"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'except_check'})</field>
            <field name="flow_stop" eval="True"/>
        </record>
        
        
       <!-- 
                               Transitions Engagement
        -->
        
        <record id="wkf_ask_trans_draft_to_validate" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_draft"/>
            <field name="act_to" ref="wkf_open_engage_to_validate"/>
        </record>
		
        <record id="wkf_ask_trans_to_validate_validate_po_invoice" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_to_validate"/>
            <field name="act_to" ref="wkf_open_engage_validate_po_and_invoice"/>
        	<field name="condition">not check_achat()</field>
        	<field name="signal">signal_validated</field>
        </record>
		
        <record id="wkf_ask_trans_to_validate_validate_po_invoice_auto" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_to_validate"/>
            <field name="act_to" ref="wkf_open_engage_validate_po_and_invoice"/>
        	<field name="condition">check_achat()</field>
        </record>
		
        <record id="wkf_ask_trans_to_validate_except_check" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_to_validate"/>
            <field name="act_to" ref="wkf_open_engage_except_check"/>
        	<field name="signal">signal_except_check</field>
        </record>
		
        <record id="wkf_ask_trans_validate_po_invoice_waiting_reception" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_validate_po_and_invoice"/>
            <field name="act_to" ref="wkf_open_engage_waiting_reception"/>
        </record>
        
        <record id="wkf_ask_trans_validate_po_invoice_waiting_invoice" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_validate_po_and_invoice"/>
            <field name="act_to" ref="wkf_open_engage_waiting_invoice"/>
        </record>
        
        <record id="wkf_ask_trans_waiting_invoice_waiting_invoice_validated" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_waiting_invoice"/>
            <field name="act_to" ref="wkf_open_engage_waiting_invoice_validated"/>
            <field name="condition">real_invoice_attached()</field>
        </record>
        
        <record id="wkf_ask_trans_waiting_reception_waiting_invoice_validated" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_waiting_reception"/>
            <field name="act_to" ref="wkf_open_engage_waiting_invoice_validated"/>
            <field name="signal">signal_received</field>
            <field name="condition">all_reception_done()</field>
        </record>
        
        <record id="wkf_ask_trans_waiting_invoice_validated_engage_to_terminate" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_waiting_invoice_validated"/>
            <field name="act_to" ref="wkf_open_engage_engage_to_terminate"/>
            <!--  <field name="signal">signal_to_terminate</field> Pour Simplifier le process -->
        </record>
        
        <record id="wkf_ask_trans_waiting_invoice_validated_except_invoice" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_waiting_invoice_validated"/>
            <field name="act_to" ref="wkf_open_engage_except_invoice"/>
            <field name="signal">signal_to_except_invoice</field>
        </record>
        
        <record id="wkf_ask_trans_to_terminate_done" model="workflow.transition">
            <field name="act_from" ref="wkf_open_engage_engage_to_terminate"/>
            <field name="act_to" ref="wkf_open_engage_done"/>
            <field name="signal">terminate_engage</field>
        </record>
		
        
        
        <!-- 
        					Workflow Demandes de Fournitures
         -->
        
        <record id="wkf_openstc_ask_prod" model="workflow">
            <field name="name">Demandes de Fournitures</field>
            <field name="osv">openstc.ask.prod</field>
            <field name="on_create" eval="True"/>
        </record>

         <!-- 
                            Activités Demandes de Fournitures
        -->
        
        <record id="wkf_openstc_ask_prod_draft" model="workflow.activity">
            <field name="name">Brouillon</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'draft'})</field>
            <field name="flow_start" eval="True"/>
        </record>
        
        <record id="wkf_openstc_ask_prod_confirmed" model="workflow.activity">
            <field name="name">Confirmée par Demandeur</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'confirmed'})</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_waiting_validation" model="workflow.activity">
            <field name="name">Attente de Validation par les Services concernés</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'waiting_validation'})</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_in_progress" model="workflow.activity">
            <field name="name">Demande en cours de Traitement</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'in_progress'})</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_done" model="workflow.activity">
            <field name="name">Demande Terminée</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'done'})</field>
            <field name="flow_stop">True</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_in_except" model="workflow.activity">
            <field name="name">Demande Annulée</field>
            <field name="wkf_id" ref="wkf_openstc_ask_prod"/>
            <field name="kind">function</field>
            <field name="action">write({'state':'in_except'})</field>
        </record>
        
        <!-- 
       								Transitions Demandes de Fournitures
         -->

		<record id="wkf_openstc_ask_prod_trans_draft_confirmed" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_draft"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_confirmed"/>
            <field name="signal">confirm</field>
        </record>
        
		<record id="wkf_openstc_ask_prod_trans_confirmed_waiting_validation" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_confirmed"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_waiting_validation"/>
            <field name="condition">have_stock_manager()</field>
        </record>
        
		<record id="wkf_openstc_ask_prod_trans_waiting_validation_in_progress" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_waiting_validation"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_in_progress"/>
            <field name="signal">validate</field>
        </record>
		
		<!-- Si pas de magazinier (cas de PontLabbé par exemple) c'est le service associé qui traite les demandes-->
        <record id="wkf_openstc_ask_prod_trans_confirmed_in_progress" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_confirmed"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_in_progress"/>
            <field name="condition">not have_stock_manager()</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_trans_to_receive_done" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_in_progress"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_done"/>
            <field name="signal">done</field>
            <field name="condition">all_merge_done()</field>
        </record>
        
        <record id="wkf_openstc_ask_prod_trans_waiting_validation_in_except" model="workflow.transition">
            <field name="act_from" ref="wkf_openstc_ask_prod_in_progress"/>
            <field name="act_to" ref="wkf_openstc_ask_prod_in_except"/>
            <field name="signal">in_except</field>
        </record>
        
    </data>
</openerp>
